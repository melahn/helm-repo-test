# 
# This workflow will create a helm charts repo and make it available publicly for test purposes.
# 
# To use the repo add the following to your helm repo list as follows ...
#   helm repo add melahn https://melahn.github.io/helm-repo-test
#
name: Create Helm Repository

# Controls when the workflow will run
on:
  # Triggers the workflow manually
  workflow_dispatch:
    inputs:
      tags:
        description: 'Deploy a Fresh Helm Repository'

jobs:
  # This workflow contains a single job called "build-helm-repo"
  build-helm-repo:
    runs-on: ubuntu-latest
    steps:
      # Checks-out the repo using v3
      - uses: actions/checkout@v3

      # Install helm
      - name: Helm tool installer
        uses: Azure/setup-helm@v1

      # Create the charts
      - name: Create the charts
        run: |
          mkdir charts
          # app-a has 1 version
          helm create charts/test-app-a
          # app-b has 2 versions
          helm create charts/test-app-b
          helm create charts/test-app-b2
          sed -i 's/0.1.0/0.2.0/g' charts/test-app-b2/Chart.yaml
          sed -i 's/test-app-b2/test-app-b/g' charts/test-app-b2/Chart.yaml
          # app-c has 3 versions
          helm create charts/test-app-c
          helm create charts/test-app-c2
          sed -i 's/0.1.0/0.2.0/g' charts/test-app-c2/Chart.yaml
          sed -i 's/test-app-c2/test-app-c/g' charts/test-app-c2/Chart.yaml
          helm create charts/test-app-c3
          sed -i 's/0.1.0/0.3.0/g' charts/test-app-c3/Chart.yaml
          sed -i 's/test-app-c3/test-app-c/g' charts/test-app-c3/Chart.yaml
          helm create charts/test-app-d
          # Add a dependency that will not be found in a helm repo and create a chart for it
          echo "dependencies:" >> charts/test-app-d/Chart.yaml
          echo "- name: test-app-e" >> charts/test-app-d/Chart.yaml
          echo "  repository: \"\"" >> charts/test-app-d/Chart.yaml
          echo "  version: 0.1.0" >> charts/test-app-d/Chart.yaml
          cd charts/test-app-d
          # Create a non-standard dependency just because I find there are some odd helm charts
          # that do this. This is *not* a best practice but is only done here to reproduce cases
          # I have seen in the interest of a complete test.
          helm create charts/test-app-e
          echo "dependencies:" >> charts/test-app-e/Chart.yaml
          echo "- name: common" >> charts/test-app-e/Chart.yaml
          echo "  repository: https://charts.bitnami.com/bitnami" >> charts/test-app-e/Chart.yaml
          echo "  version: 1.x.x"  >> charts/test-app-e/Chart.yaml
          echo "- name: test-app-f" >> charts/test-app-e/Chart.yaml
          echo "  repository: \"\"" >> charts/test-app-e/Chart.yaml
          echo "  version: 0.1.0"  >> charts/test-app-e/Chart.yaml
          cd charts/test-app-e
          helm create charts/test-app-f
          echo "dependencies:" >> charts/test-app-f/Chart.yaml
          echo "- name: common" >> charts/test-app-f/Chart.yaml
          echo "  repository: https://charts.bitnami.com/bitnami" >> charts/test-app-f/Chart.yaml
          echo "  version: 1.x.x" >> charts/test-app-f/Chart.yaml
          cd ../../../..
          # add the icon field that lint likes
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-a/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-b/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-b2/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-c/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-c2/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-c3/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-d/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-d/charts/test-app-e/Chart.yaml
          echo "icon: \"https://helm.sh/img/helm.svg\"" >> charts/test-app-d/charts/test-app-e/charts/test-app-f/Chart.yaml
          # lint the resulting modified charts
          helm lint charts/test-app-d
          helm lint charts/test-app-d/charts/test-app-e
          helm lint charts/test-app-d/charts/test-app-e/charts/test-app-f
      # Package the charts
      - name: Package the charts
        run: |
          helm package charts/test-app-a
          helm package charts/test-app-b
          helm package charts/test-app-b2
          helm package charts/test-app-c
          helm package charts/test-app-c2
          helm package charts/test-app-c3
          helm package charts/test-app-d
      # Create the index
      - name: Create the index
        run: |
          helm repo index --url https://melahn.github.io/helm-repo-test .
          cat index.yaml
      # Commit to git
      - name: Commit to git
        run: |
          rm -rf charts
          if [[ `git status --porcelain` ]]; then
              git config --global user.email "melahn@github"
              git config --global user.name "GitHub Action (create-helm-repo.yml)"
              git add *.tgz
              git add index.yaml
              git commit -m "Helm Repository Updated from GitHub action create-helm-repo"
              git pull origin main
              git push origin main
          else
              echo no git changes found
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
